## 红岩夏季安全开发考核

### 开发内容：C2服务端，参考cobalt strike

#### 李昊

#### 使用语言Golang

#### 实现内容：

1. 并发接受和控制多个客户端
2. 支持心跳检测
3. 可以实现单条cmd命令执行
4. 可以自动进行简单的信息搜集
4. 自动执行指令可接受json文件拓展
5. 可以进行文件浏览
6. 可以上传和下载文件
6. 服务端用户行为记录
7. 自定义通信协议
8. 自定义通信加密
8. 屏幕截图

### 服务端的使用

1. 启动客户端，然后进行初始化，之后就可以等待服务端的连接

2.  当客户端连接后会出现“新的主机”的字样，并会显示主机名称和用户

3. 此时按1进入选择主机的界面按0刷新

4. 再选择主机

5. 然后进入主机选项界面，主要有一下几个功能：

   1. 刷新
   2. 主机信息搜集
   3. 域信息搜集
   4. 执行cmd指令
   5. 文件浏览及上传下载
   6. 一键打包信息搜集
   7. 截取屏幕
   
   * 其中按键1和其他键是刷新
   * 在**主机信息搜集**和**域信息搜集**选项里会列出一些常用的指令，包括ip，用户，管理员，路由表之类的
   * 详情可进入查看，按0返回上一层
   * cmd指令执行的指令彼此是独立的
   * 当需要进行信息搜集，整理就可以使用指令6一键打包信息搜集，该指令会把上面信息搜集指令都执行一遍，并且将结果写入文件中
   * 指令5是文件查看，进入后就可以选择盘符，统一使用 “/” 作为分节符，例如进入D盘就可以输入 `cd C:`
     * 进入D盘就会列出D盘的信息，然后可以继续进入下一个文件夹：`cd windows`
     * 返回上一级目录可以使用 ` cd ..`
     * 如果需要 **当前**文件夹下某个文件，只需要输入get 文件名称即可，例如`get 1.txt`
     * 当要给当前文件夹发送文件的时候，就需要使用 put指令，输入put指令后需要输入本地要上传文件的路径 **使用绝对路径**例如 C:/windows/1.txt之后就可以发送文件了  
   
6. 使用json文件拓展

   运行程序后后，默认会创建一个CmdJson的文件夹，在里面放上json文件 **CmdJosn.json**文，然后按照如下格式存入指令：

   ```json
   [{"Name": "用户", "Cmd": "whoami"},
   {"Name": "用户2", "Cmd": "whoami"}]
   ```

   name的键值是文件保存的名字，Cmd的键值就是需要执行的指令

​					

### 自定义通信协议


客户端传入内容：

| 类型         | 意义         |
| ------------ | ------------ |
| Alive\r\n    | 心跳检测     |
| Download\r\n | 文件传输     |
| Disk\r\n     | 获取盘符信息 |
| 其他         | 呈现在屏幕   |
| 消息结尾     | !@#$^&*()_   |

服务端传入内容：

| 类型                           | 意义                             |
| ------------------------------ | -------------------------------- |
| Cmd\r\n指令                    | 执行cmd指令                      |
| Document\r\n                   | 进入查看文件状态                 |
| get 绝对路径                   | 获得文件（需要进入查看文件状态） |
| put 绝对路径 文件大小 文件内容 | 发送文件（需要进入查看文件状态） |
| cd  绝对路径/..                | 进入目录（需要进入查看文件状态） |
| dir 绝对路径                   | 查看文件（需要进入查看文件状态） |

### 自定义加密

#### 加密逻辑：

* 通过月和日得到一位数的加密数字
* 通过加密数字生成三个密钥
* 将密钥延长两位延长两位
* 将明文base64然后转换为Unicode编码
* 然后明文按照顺序与密钥异或
* 得到密文

#### 解密逻辑：

* 密文先按照逆序异或得到base64加密
* 然后base64解密即可

#### 具体实现：

m=月分

d=日

c1 =（d+m）*|（d-m）| 

c2 = （月左移1位）*（日左移一位）*10000

c3 = d * m * 1000  000

得到密钥c1 c2 c3 然后依次异或然后得到密文

### 需要进一步改进的地方

* 可以用数据库来记录用户使用记录

* 一键执行命令第二次不会覆写，需要手动删除才行

  
