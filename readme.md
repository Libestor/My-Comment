## 红岩夏季安全开发考核

### 开发内容：C2服务端，参考cobalt strike

#### 李昊

#### 使用语言Golang

#### 实现内容：

1. 并发接受和控制多个客户端
2. 支持心跳检测
3. 可以实现单条cmd命令执行
4. 可以自动进行简单的信息搜集
4. 自动执行指令可接受json文件拓展
5. 可以进行文件浏览
6. 可以上传和下载文件
6. 服务端用户行为记录
7. 自定义通信协议
8. 自定义通信加密
8. 屏幕截图

### 服务端的使用

1. 启动客户端，然后进行初始化，之后就可以等待客户端的连接

2.  当客户端连接后会出现“新的主机”的字样，并会显示主机名称和用户

3. 此时按1进入选择主机的界面按0刷新

4. 再选择主机

5. 然后进入主机选项界面，主要有一下几个功能：

   1. 刷新
   2. 主机信息搜集
   3. 域信息搜集
   4. 执行cmd指令
   5. 文件浏览及上传下载
   6. 一键打包信息搜集
   7. 截取屏幕
   
   * 其中按键1和其他键是刷新
   * 在**主机信息搜集**和**域信息搜集**选项里会列出一些常用的指令，包括ip，用户，管理员，路由表之类的
   * 详情可进入查看，按0返回上一层
   * cmd指令执行的指令彼此是独立的
   * 当需要进行信息搜集，整理就可以使用指令6一键打包信息搜集，该指令会把上面信息搜集指令都执行一遍，并且将结果写入文件中
   * 指令5是文件查看，进入后就可以选择盘符，统一使用 “/” 作为分节符，例如进入D盘就可以输入 `cd C:`
     * 进入D盘就会列出D盘的信息，然后可以继续进入下一个文件夹：`cd windows`
     * 返回上一级目录可以使用 ` cd ..`
     * 如果需要 **当前**文件夹下某个文件，只需要输入get 文件名称即可，例如`get 1.txt`
     * 当要给当前文件夹发送文件的时候，就需要使用 put指令，输入put指令后需要输入本地要上传文件的路径 **使用绝对路径**例如 C:/windows/1.txt之后就可以发送文件了  
   
6. 使用json文件拓展

   运行程序后后，默认会创建一个CmdJson的文件夹，在里面放上json文件 **CmdJosn.json**文，然后按照如下格式存入指令：

   ```json
   [{"Name": "用户", "Cmd": "whoami"},
   {"Name": "用户2", "Cmd": "whoami"}]
   ```

   name的键值是文件保存的名字，Cmd的键值就是需要执行的指令
   
6. 如果选择截图功能，需要几秒钟才可以发送过来，稍等即可。

7. 在选择主机界面还有一个选项是服务端设置，主要有两个设置，一个是调试模式，一个是是否按照ip地址加端口主机区分

   * 默认这两个都是关闭的，调试功能打开后，服务端的每一次数据的运输和计算都会显示在屏幕，十分凌乱，但是好用
   * 是否按照ip地址和端口区分可以用来细化主机，当开启次功能是，靶机可以开启几个客户端，这几个客户端直接互斥，此时用户打开多个客户端的是都具有连接能力的

​					

### 自定义通信协议


客户端传入内容：

| 类型         | 意义         |
| ------------ | ------------ |
| Alive\r\n    | 心跳检测     |
| Download\r\n | 文件传输     |
| Disk\r\n     | 获取盘符信息 |
| 其他         | 呈现在屏幕   |
| 消息结尾     | !@#$^&*()_   |

服务端传入内容：

| 类型                           | 意义                             |
| ------------------------------ | -------------------------------- |
| Cmd\r\n指令                    | 执行cmd指令                      |
| Document\r\n                   | 进入查看文件状态                 |
| get 绝对路径                   | 获得文件（需要进入查看文件状态） |
| put 绝对路径 文件大小 文件内容 | 发送文件（需要进入查看文件状态） |
| cd  绝对路径/..                | 进入目录（需要进入查看文件状态） |
| dir 绝对路径                   | 查看文件（需要进入查看文件状态） |

### 自定义加密

#### 加密逻辑：

* 通过月和日得到一位数的加密数字
* 通过加密数字生成三个密钥
* 将密钥延长两位延长两位
* 将明文base64然后转换为Unicode编码
* 然后明文按照顺序与密钥异或
* 得到密文

#### 解密逻辑：

* 密文先按照逆序异或得到base64加密
* 然后base64解密即可

#### 具体实现：

m=月分

d=日

c1 =（d+m）*|（d-m）| 

c2 = （月左移1位）*（日左移一位）*10000

c3 = d * m * 1000  000

然后用取c1 c2 c3的位数作为加密数字

然后将加密数字延长至两位，例如：8变为88，得到三个密钥m1 m2 m3

得到密钥通过密钥m1 m2 m3 然后依次异或然后得到密文

### 程序运行逻辑

1. 启动程序后，会先进行初始化，包括新建文件夹，监听端口
   1. 之后会启动监听协程，一旦有客户端连接，就会初始化一个map来存储这个连接的信息，包括这个连接的用户，通信通道等等
   2. 创建完map后，就会为这个连接启动信息接受协程，信息处理协程，信息发送协程，并向客户端发送whoami来确认连接
   3. 当客户端返回whoami信息的时候，就会将这个消息发送到主程序上，让用户可见，并告知新的主机上线了
   4. 客户端和服务端的心跳检测是不被用户所感知的

2. 监听后就是进入用户界面，用户界面是主程序，里面有各种指令和选项可供使用者使用

3. 通常情况下1都是刷新，所以当你不知道干嘛的时候按1就对了

4. 在文件操作的时候，只需要输入1就可以查看文件操作帮助

5. 文件查看原理本质就是通过用户输入的地址保存在服务端，然后呈现在用户，当在当前路径下操作的时候，实际上是会加上全部路径发送出去，也就是面向用户是相对路径，面对程序是绝对路径

   

### 模块介绍

#### control.go

*  主程序，所属main包初始化各个文件夹，调用各个协程
* 用户交互界面，各个命令生成的地方，通过各个管道与各个协程通信，发送用户的输入和接受输出
* 外部文件调度的地方，可以接入第三方文件，例如json文件

#### cobalt_tcp.go

* 通信的核心文件，属于cobalt_tcp 包

* 对用户发送过来的数据进行第一次处理，然后通过调用加密包加密，最终发送出去
* 所有发送来的消息都会率先进入此包，它会确保消息完整，并交由解密包解密，最终通过呈现到终端或者打印到文件

#### cobalt_file.go

*  文件操作包，属于cobalt_file包
* 管理着部分文件的打开，写入与关闭，以及对错误的呈现于反馈
* 同时也用于记录用户的输入，并整理成文件

#### cobalt_crypto.go

* 文件加解密包，输入cobalt_crypte包
* 处理所有发送文件的加密和接受的所有文件的解密
* 并且预留了一些常用来转换字符的方法函数



### 需要进一步改进的地方

* 可以用数据库来记录用户使用记录

* 一键执行命令第二次不会覆写，需要手动删除才行

* 主机超过60s未通信无法通报(函数都写好了，出了个bug，就没上)

  

### 其他

如何在windows上关闭客户端

1. 让客户端和服务端连接
2. 然后输入指令`netstat -aon|findstr "6666"` 找到占用6666端口的程序pid
3. 然后终止程序` taskkill /T /F /PID 此处写pid `

